{"version":3,"file":"compile-ngc.transform.js","sourceRoot":"","sources":["../../../../src/lib/ng-package/entry-point/compile-ngc.transform.ts"],"names":[],"mappings":";;;AAAA,6BAA6B;AAC7B,iCAAiC;AACjC,2BAA2B;AAC3B,qDAAwE;AACxE,yEAAoE;AACpE,6DAAyD;AACzD,gDAAiE;AACjE,oCAAgF;AAGzE,MAAM,0BAA0B,GAAG,CAAC,mBAAoD,EAAa,EAAE;IAC5G,OAAO,gCAAoB,CAAC,KAAK,EAAC,KAAK,EAAC,EAAE;QACxC,MAAM,OAAO,GAAG,GAAG,CAAC;YAClB,UAAU,EAAE,KAAK;YACjB,YAAY,EAAE,KAAK;SACpB,CAAC,CAAC,KAAK,CAAC,0CAA0C,CAAC,CAAC;QAErD,IAAI;YACF,MAAM,UAAU,GAAmB,KAAK,CAAC,IAAI,CAAC,8BAAsB,EAAE,CAAC,CAAC;YACxE,MAAM,WAAW,GAAqB,KAAK,CAAC,MAAM,CAAC,oBAAY,CAAC,CAAC;YACjE,sCAAsC;YACtC,MAAM,QAAQ,GAAG,uCAA4B,CAAC,UAAU,CAAC,IAAI,CAAC,QAAQ,EAAE,WAAW,CAAC,CAAC;YAErF,6BAA6B;YAC7B,MAAM,EAAE,OAAO,EAAE,YAAY,EAAE,GAAG,UAAU,CAAC,IAAI,CAAC,gBAAgB,CAAC;YACnE,MAAM,EAAE,QAAQ,EAAE,MAAM,EAAE,iBAAiB,EAAE,GAAG,UAAU,CAAC,IAAI,CAAC,UAAU,CAAC;YAC3E,MAAM,EAAE,qBAAqB,EAAE,mBAAmB,EAAE,mBAAmB,GAAG,IAAI,mBAAmB,CAAC,QAAQ,EAAE,MAAM,EAAE,iBAAiB,CAAC,EAAE,GAAG,UAAU,CAAC,KAAK,CAAC;YAC5J,UAAU,CAAC,KAAK,CAAC,mBAAmB,GAAG,mBAAmB,CAAC;YAE3D,MAAM,aAAa,GAAG,QAAQ,CAAC,OAAO,CAAC,SAAS;gBAC9C,CAAC,CAAC,IAAI,8BAAa,CAAC,mBAAmB,EAAE,QAAQ,CAAC,OAAO,EAAE,QAAQ,CAAC,OAAO,EAAE,WAAW,CAAC;gBACzF,CAAC,CAAC,SAAS,CAAC;YAEd,IAAI,aAAa,IAAI,CAAC,UAAU,CAAC,IAAI,CAAC,UAAU,CAAC,qBAAqB,EAAE;gBACtE,+EAA+E;gBAC/E,MAAM,aAAa,CAAC,OAAO,EAAE,CAAC;aAC/B;YAED,MAAM,yCAAkB,CACtB,KAAK,EACL,QAAQ,EACR,qBAAqB,EACrB,mBAAmB,EACnB;gBACE,MAAM,EAAE,IAAI,CAAC,OAAO,CAAC,OAAO,CAAC;gBAC7B,cAAc,EAAE,IAAI,CAAC,OAAO,CAAC,YAAY,CAAC;gBAC1C,WAAW,EAAE,IAAI;gBACjB,MAAM,EAAE,EAAE,CAAC,YAAY,CAAC,MAAM;aAC/B,EACD,aAAa,CACd,CAAC;SACH;QAAC,OAAO,KAAK,EAAE;YACd,OAAO,CAAC,IAAI,EAAE,CAAC;YACf,MAAM,KAAK,CAAC;SACb;QAED,OAAO,CAAC,OAAO,EAAE,CAAC;QAClB,OAAO,KAAK,CAAC;IACf,CAAC,CAAC,CAAC;AACL,CAAC,CAAC;AAjDW,QAAA,0BAA0B,8BAiDrC","sourcesContent":["import * as path from 'path';\nimport * as ts from 'typescript';\nimport * as ora from 'ora';\nimport { Transform, transformFromPromise } from '../../graph/transform';\nimport { compileSourceFiles } from '../../ngc/compile-source-files';\nimport { NgccProcessor } from '../../ngc/ngcc-processor';\nimport { setDependenciesTsConfigPaths } from '../../ts/tsconfig';\nimport { isEntryPointInProgress, EntryPointNode, isEntryPoint } from '../nodes';\nimport { StylesheetProcessor as StylesheetProcessorClass } from '../../styles/stylesheet-processor';\n\nexport const compileNgcTransformFactory = (StylesheetProcessor: typeof StylesheetProcessorClass): Transform => {\n  return transformFromPromise(async graph => {\n    const spinner = ora({\n      hideCursor: false,\n      discardStdin: false,\n    }).start(`Compiling TypeScript sources through NGC`);\n\n    try {\n      const entryPoint: EntryPointNode = graph.find(isEntryPointInProgress());\n      const entryPoints: EntryPointNode[] = graph.filter(isEntryPoint);\n      // Add paths mappings for dependencies\n      const tsConfig = setDependenciesTsConfigPaths(entryPoint.data.tsConfig, entryPoints);\n\n      // Compile TypeScript sources\n      const { esm2015, declarations } = entryPoint.data.destinationFiles;\n      const { basePath, cssUrl, styleIncludePaths } = entryPoint.data.entryPoint;\n      const { moduleResolutionCache, ngccProcessingCache, stylesheetProcessor = new StylesheetProcessor(basePath, cssUrl, styleIncludePaths) } = entryPoint.cache;\n      entryPoint.cache.stylesheetProcessor = stylesheetProcessor;\n\n      const ngccProcessor = tsConfig.options.enableIvy\n        ? new NgccProcessor(ngccProcessingCache, tsConfig.project, tsConfig.options, entryPoints)\n        : undefined;\n\n      if (ngccProcessor && !entryPoint.data.entryPoint.isSecondaryEntryPoint) {\n        // Only run the async version of NGCC during the primary entrypoint processing.\n        await ngccProcessor.process();\n      }\n\n      await compileSourceFiles(\n        graph,\n        tsConfig,\n        moduleResolutionCache,\n        stylesheetProcessor,\n        {\n          outDir: path.dirname(esm2015),\n          declarationDir: path.dirname(declarations),\n          declaration: true,\n          target: ts.ScriptTarget.ES2015,\n        },\n        ngccProcessor,\n      );\n    } catch (error) {\n      spinner.fail();\n      throw error;\n    }\n\n    spinner.succeed();\n    return graph;\n  });\n};\n"]}